<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title></title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="book.css">

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="index.html">Home</a></li><li class="chapter-item affix "><li class="part-title">src</li><li class="chapter-item "><a href="src/SelfDestructMeta.sol/contract.SelfDestructMeta.html">SelfDestructMeta</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rainprotocol/metamorphic-metadata" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="metamorphic-metadata"><a class="header" href="#metamorphic-metadata">Metamorphic metadata</a></h1>
<p>Solidity appends CBOR metadata to all contracts that it compiles by default.</p>
<p>The CBOR metadata includes an IPFS hash of the source code used to build the
bytecode and some other metadata.</p>
<p>As I understand the CBOR metadata is a &quot;Solidity thing&quot; NOT an &quot;EVM thing&quot;.</p>
<p>I.e. if I were to move the pc into the metadata with a jump and it landed at a
valid jump destination then the EVM, knowing nothing about CBOR metadata, would
happily run the bytes of the metadata as EVM opcodes.</p>
<p>To test this I wrote a script that brute forces IPFS hashes by modifying
<strong>comments</strong> in the source code until it finds an IPFS hash that contains the
2-byte sequence <code>0x5bff</code> which is <code>JUMPDEST SELFDESTRUCT</code>.</p>
<p>For example, our deployed bytecode might look like:</p>
<p><code>0x6080604052348015600f57600080fd5b506004361060285760003560e01c806325d20ef114602d575b600080fd5b60436004803603810190603f9190609b565b6045565b005b605d615bff8291505060598163ffffffff16565b5050565b606360c3565b565b600080fd5b6000819050919050565b607b81606a565b8114608557600080fd5b50565b6000813590506095816074565b92915050565b60006020828403121560ae5760ad6065565b5b600060ba848285016088565b91505092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052605160045260246000fdfea2646970667358221220748a4af9208c7ac7d2d439e7ae39963e9d9825504480f252df41db0bb35bff6564736f6c63430008120033</code></p>
<p>Where the final bytes are CBOR metadata:</p>
<pre><code>a2
64 69706673 5822 1220748a4af9208c7ac7d2d439e7ae39963e9d9825504480f252df41db0bb35bff65
64 736f6c63 43 000812
00 33
</code></pre>
<p>Encoding reference:</p>
<p>https://docs.soliditylang.org/en/v0.8.19/metadata.html#encoding-of-the-metadata-hash-in-the-bytecode</p>
<p>Note the <code>0x5bff</code> near the end of the IPFS hash.</p>
<p>The only thing we need <em>anywhere</em> in our contract to jump to the IPFS hash is</p>
<pre><code class="language-solidity">function() f;
assembly { f := _pc }
f();
</code></pre>
<p>Where <code>_pc</code> is the byte offset of the jump destination embedded in the IPFS hash.</p>
<p><code>_pc</code> is just a <code>uint256</code>, it can come from anywhere, calldata, storage,
hardcoded, etc.</p>
<p>Normally this little snippet can be very powerful and useful. For example, I've
used this to implement an <a href="https://github.com/rainprotocol/rain.lib.interpreter">onchain interpreter</a>.</p>
<p>But it is dangerous if there are any jump destinations that it can reach that you
didn't expect.</p>
<h2 id="implications"><a class="header" href="#implications">Implications</a></h2>
<h3 id="metamorphic-backdoors"><a class="header" href="#metamorphic-backdoors">Metamorphic backdoors</a></h3>
<p>Metamorphic smart contracts use a combination of <code>CREATE2</code> and <code>SELFDESTRUCT</code> to
redeploy new bytecode at an existing address.</p>
<p>https://0age.medium.com/the-promise-and-the-peril-of-metamorphic-contracts-9eb8b8413c5e</p>
<p>This can be used to backdoor contracts by making them mutable, such as the
Tornado Cash governance attack.</p>
<p>https://github.com/coinspect/learn-evm-attacks/tree/master/test/Business_Logic/TornadoCash_Governance</p>
<p>There are attempts to automatically scan for metamorphic behaviour but strict
checks for <code>SELFDESTRUCT</code> yield false positives, and hueristic based checks have
enough wiggle room to be gamed if an attacker knows how the scanner works.</p>
<p>However, at least the a16z scanner SHOULD detect this particular backdoor
(not tested) because it checks all bytes of the runtime code that follow a jump
destination anywhere in the code.</p>
<p>https://metamorphic.a16zcrypto.com/</p>
<p>https://github.com/a16z/metamorphic-contract-detector/blob/main/metamorphic_detect/opcodes.py#L52</p>
<p><strong>On the other hand, reading the verified &quot;Contract Source Code&quot; on Etherscan and
looking for self destruct calls in the Solidity source code WILL NOT reveal a
metamorphic backdoor in the metadata. The metamorphic behaviour is ONLY visible
by analysing the raw bytecode directly.</strong></p>
<p><strong>This is frustrating because it is just as important, if not more important,
that people can <em>read</em> smart contracts than can write them. If invisible code
can execute that does not appear in the verified source code representation, that
forces code <em>readers</em> at least partially back down to raw bytecode analysis.</strong></p>
<p>This is somewhat mitigated by the fact that using assembly to dispatch a function
directly is &quot;weird&quot;, and so might give someone the clue that they should dig
deeper. An attacker could probably craft some plausible excuse, given the payout
for an attack is multimillion $, if Tornado Cash is a fair example. But at least
the attack isn't completely invisible from the source code, there's a single
&quot;out of band&quot; function call giving it away.</p>
<p>If the attacking contract was assembly heavy &quot;for gas reasons&quot; it would be
relatively easy to slip a function pointer in there somewhere and hope that
nobody notices.</p>
<p>The core issue here is that &quot;people know&quot; that <code>SELFDESTRUCT</code> can cause
metamorphic behaviour, but probably don't know that function pointers can reach
jump destinations outside the verified source code that they read on etherscan.
This writeup is raising visibility on that issue.</p>
<h3 id="other-attacks"><a class="header" href="#other-attacks">Other attacks</a></h3>
<p>Actually, having a jump destination in the IPFS hash allows for a lot of
shenanigans as that's a full 34 bytes for an attacker to work with. For maximum
stealth they can only use a few bytes as they have to brute force a real IPFS
hash, and more bytes = more work, as we know from PoW. 2 bytes for a metamorphic
attack only takes a few minute to an hour to brute force, but more than this will
increase the work exponentially.</p>
<p>If the attacker feels comfortable that the IPFS hash won't actually be checked,
they're free to use the full 34 bytes, or potentially even more of the CBOR
metadata.</p>
<p>The main issue is that what verified source code based viewers like Etherscan
consider &quot;code&quot; is NOT the full executable bytecode, and it's possible to jump
to execution paths outside the logic displayed to the user.</p>
<h2 id="mitigation"><a class="header" href="#mitigation">Mitigation</a></h2>
<h3 id="consumers-use-a-bytecode-level-scanner"><a class="header" href="#consumers-use-a-bytecode-level-scanner">Consumers: Use a bytecode level scanner</a></h3>
<p>Scan for metamorphic behaviour at the bytecode level if you want to avoid it.</p>
<p>Simply eyeballing the verified source code for self destruct calls is NOT enough.</p>
<p>You also need to check every suspicious jump and/or every possible jump
destination, including those in bytecode OUTSIDE the visible source code.</p>
<h3 id="contract-authorsconsumers-dont-usetrust-cbor-metadata"><a class="header" href="#contract-authorsconsumers-dont-usetrust-cbor-metadata">Contract authors/consumers: Don't use/trust CBOR metadata</a></h3>
<p>As I understand, the CBOR metadata isn't even used/checked by Etherscan anyway.</p>
<p>It is presented as-is in a tiny grey box like <code>ipfs://...</code> but it's up to you to
download whatever is on the other side of that. Etherscan doesn't even check that
what it displays is a valid IPFS URL with a valid encoded CID.</p>
<p>The same information could be emitted in an event upon constructing a contract,
it doesnt need to be in the literal executable bytecode onchain.</p>
<p>Recent versions of Solidity allow completely eliding the CBOR metadata, their
reasoning is that it isn't deterministic anyway. This is true, I get different
IPFS hashes for this repo when I run it locally on my Mac vs. when I run it on
Github Actions on ubuntu.</p>
<h3 id="solidity-provide-an-escapedsanitised-cbor-metadata"><a class="header" href="#solidity-provide-an-escapedsanitised-cbor-metadata">Solidity: Provide an escaped/sanitised CBOR metadata</a></h3>
<p>EVM itself already has a similar issue with the <code>PUSH</code> EVM opcodes. It is
possible that push data just coincidentally includes what would otherwise be a
jump destination. Every byte of push data has a program counter, so it would be
possible to jump into a push.</p>
<p>However, EVM DOES NOT allow jumping into push data, this is treated as an invalid
jump destination even if <code>JUMPDEST</code> appears inline after a <code>PUSH</code>.</p>
<p>Solidity devs <em>could</em> escape/sanitise their CBOR metadata as inline with <code>PUSH</code>
ops. A standard 53 byte CBOR metadata could be escaped with just 2 <code>PUSH</code> ops.
That would completely negate the ability for anyone to hide anything in the
CBOR metadata.</p>
<p>I reported the above and received this response:</p>
<blockquote>
<p>this does not count as a vulnerability or bug as it's messing with a function
pointer in inline assembly.</p>
</blockquote>
<p>I assume it's unlikely they will sanitise their metadata in the near future.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="selfdestructmeta"><a class="header" href="#selfdestructmeta">SelfDestructMeta</a></h1>
<p><a href="https://github.com/rainprotocol/metamorphic-metadata/blob/365d6c703830afb308abc294f34d0bba45697590/src/SelfDestructMeta.sol">Git Source</a></p>
<h2 id="functions"><a class="header" href="#functions">Functions</a></h2>
<h3 id="poof"><a class="header" href="#poof">poof</a></h3>
<p>Comments seem harmless but they change the meta hash.</p>
<pre><code class="language-solidity">function poof(uint256 _pc) external;
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="solidity.min.js"></script>

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
